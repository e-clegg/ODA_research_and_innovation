slice(1) %>%
# remove unpopulated budget status records
filter(!is.na(budget_status)) %>%
ungroup()
# Find activities with multiple budgets
multiple_budgets <- activity_list_unnest_7 %>%
group_by(iati_identifier, period_start, period_end) %>%
summarise(count = n()) %>%
filter (count > 1)
# Keep only the committed budget in these cases
activity_list_unnest_7_dedup <- activity_list_unnest_7 %>%
filter(!(iati_identifier %in% multiple_budgets$iati_identifier) |
budget_status == "Committed") %>%
group_by(iati_identifier, budget_status, currency) %>%
summarise(period_start = min(period_start),
period_end = max(period_end),
amount = sum(amount))
test2 <- filter(activity_list_unnest_7_dedup, str_detect(iati_identifier, "222655-300342-104"))
View(test2)
# 8) Unlist start/end dates
activity_list_unnest_9 <- partner_activity_comb %>%
unnest(cols = activity_date,
keep_empty = TRUE) %>%
select(iati_identifier,
date = iso_date,
date_type = type.name) %>%
# take the first date in cases of two of the same time
group_by(iati_identifier, date_type) %>%
slice(1) %>%
spread(key = date_type, value = date) %>%
mutate(start_date = coalesce(`Actual start`, `Planned start`),
end_date = coalesce(`Actual end`, `Planned End`)) %>%
select(iati_identifier, start_date, end_date)
# Join unnested info to original data
activity_list <- activity_list_base %>%
left_join(activity_list_unnest_1, by = "iati_identifier") %>%
left_join(activity_list_unnest_2, by = "iati_identifier") %>%
left_join(activity_list_unnest_3, by = "iati_identifier") %>%
left_join(activity_list_unnest_4, by = "iati_identifier") %>%
left_join(activity_list_unnest_5, by = "iati_identifier") %>%
left_join(activity_list_unnest_6, by = "iati_identifier") %>%
left_join(activity_unnest_7_dedup, by = "iati_identifier") %>%
#left_join(activity_list_unnest_8, by = "iati_identifier") %>%
left_join(activity_list_unnest_9, by = "iati_identifier")
# Join unnested info to original data
activity_list <- activity_list_base %>%
left_join(activity_list_unnest_1, by = "iati_identifier") %>%
left_join(activity_list_unnest_2, by = "iati_identifier") %>%
left_join(activity_list_unnest_3, by = "iati_identifier") %>%
left_join(activity_list_unnest_4, by = "iati_identifier") %>%
left_join(activity_list_unnest_5, by = "iati_identifier") %>%
left_join(activity_list_unnest_6, by = "iati_identifier") %>%
left_join(activity_list_unnest_7_dedup, by = "iati_identifier") %>%
#left_join(activity_list_unnest_8, by = "iati_identifier") %>%
left_join(activity_list_unnest_9, by = "iati_identifier")
# Assign a reporting org if the reporting partner is implementing
# the activity themselves
activity_list <- activity_list %>%
mutate(reporting_org = coalesce(reporting_org, reporting_org_ref, extending_org, gov_funder))
# Reorder columns and add date of refresh
activity_list <- activity_list %>%
select(reporting_org_ref, reporting_org_type, reporting_org, iati_identifier,
hierarchy, activity_status, flow_type, fcdo_activity_id,
activity_title, General, Objectives, country_code, start_date, end_date,
country_name, sector_code, sector_name,
# policy_marker_code, policy_marker_name, policy_significance, climate_focus,
partner, partner_role, partner_ref, partner_country, gov_funder,
extending_org, fund,
budget_status, amount, period_start, period_end, currency) %>%
unique() %>%
mutate(refresh_date = Sys.Date())
# Add Fund label
activity_list <- activity_list %>%
select(-extending_org) %>%
left_join(select(iati_activity_ids, gov_funder, iati_id, funding_iati_id),
by = c("iati_identifier" = "iati_id", "gov_funder")) %>%
mutate(programme_id = coalesce(funding_iati_id, fcdo_activity_id)) %>%
mutate(fund = coalesce(fund, "FCDO fully funded"),
gov_funder = coalesce(gov_funder, "Foreign, Commonwealth and Development Office"))
activity_list <- activity_list %>%
mutate(all_countries = country_name) %>%
rename(activity_description = General)
# Remove WHO non-research/innovation activities
activity_list <- activity_list %>%
filter(is.na(reporting_org_ref) |
!(reporting_org_ref == "XM-DAC-928") |
str_detect(activity_title, "research|innovation"))
# Add missing FCDO activity IDs
activity_list <- activity_list %>%
mutate(programme_id = case_when(str_detect(iati_identifier, "XM-DAC-301-2") & str_detect(activity_title, "CLARE") ~ "GB-GOV-1-300126",
str_detect(iati_identifier, "XM-DAC-301-2") & str_detect(activity_title, "CARIAA") ~ "GB-1-203506",
str_detect(iati_identifier, "XI-IATI-AGR") ~ "GB-1-203052",
reporting_org_ref == "XM-DAC-47015" & str_detect(iati_identifier, "Windows1and2") ~ "GB-1-204764",
TRUE ~ programme_id))
# Save to Rdata file
saveRDS(activity_list, file = "Outputs/partner_activity_list.rds")
# Check funds, funders
table(activity_list$fund)
table(activity_list$gov_funder)
table(activity_list$currency)
# Check specific partner
test1 <- filter(activity_list, str_detect(reporting_org, "Liverpool"))
# Read in list of IATI activities (from funders and select delivery partners)
iati_activity_list <- readRDS(file = "Outputs/gov_list_final.rds")
partner_iati_list <- readRDS(file = "Outputs/partner_activity_list.rds")
# Filter gov department records for minimum granularity
iati_projects <- iati_activity_list %>%
filter(  str_detect(iati_identifier, "GB-GOV-3") |   # ex-FCO activities
str_detect(iati_identifier, "1-205053") |   # South Asia Country Research Fund (FCDO)
str_detect(iati_identifier, "1-204584") |   # Policy Research Fund (FCDO)
str_detect(iati_identifier, "UKSA") |   # UKSA awards (GCRF)
str_detect(iati_identifier, "NEWT-MO") |   # Met Office awards (Newton)
str_detect(iati_identifier, "NEWT-BIS") |  # Other Met Office awards?
str_detect(iati_identifier, "NEWT-BC") |  # British Council
str_detect(iati_identifier, "GCRF-Clm") |  # Academies
str_detect(iati_identifier, "RS-GCRF|NEWT-RS") |  # Royal Society
str_detect(iati_identifier, "RAENG-GCRF|NEWT-RAE") |  # Royal Academy of Engineering
str_detect(iati_identifier, "GB-GOV-7")     # Defra activities
) %>%
filter(flow_type == "ODA") %>%
mutate(fund = if_else(is.na(fund), "Unknown", fund)) %>%
plyr::rbind.fill(partner_iati_list) # Add partner activities
# Keep required fields
iati_projects_final <- iati_projects %>%
mutate(Funder = coalesce(gov_funder, reporting_org),
lead_org_country = "",
partner_org_name = "",
partner_org_country = "",
extending_org = coalesce(extending_org, reporting_org),
last_updated = quarter_end_date) %>%
select(id = iati_identifier,
title = activity_title,
abstract = activity_description,
start_date,
end_date,
amount,
period_start,
period_end,
currency,
extending_org,
lead_org_name = partner,
lead_org_country = partner_country,
partner_org_name,
partner_org_country,
iati_id = programme_id,
Fund = fund,
Funder,
recipient_country = all_countries,
subject = sector_name,
status = activity_status,
last_updated
)
# Add IATI link to awards
iati_projects_final <- iati_projects_final %>%
mutate(link = paste0("https://d-portal.org/ctrack.html#view=act&aid=", id))
# Clean up
rm(request)
rm(response)
all_projects <- rbind(ukri_projects_final, nihr_projects_final,
iati_projects_final, wellcome_grants_final,
collated_spreadsheet_data)
# Change terminology around award status
all_projects <- all_projects %>%
mutate(status = if_else(status %in% c("Contracted", "Implementation"), "Active", status)) %>%
unique()
# Save as R file (to read back in if needed)
saveRDS(all_projects, file = "Outputs/all_projects.rds")
# 7) CHECKING ----
test1 <- filter(all_projects, str_detect(extending_org, "Liverpool"))
View(test1)
#####################################
# Script 4
# Extract transactions for activities covering multiple awards
#####################################
# Set quarter end date for IATI information
quarter_end_date <- as.Date("2021-06-30")
# A) Extraction ----
# Manually specify the IATI activities to extract transactions for
id_list <- c("US-EIN-042103594-PPE3978774",
"US-EIN-042103594-GCCI-3978870",
"GB-CHC-1177110-R2HC",
"GB-CHC-1177110-HIF")
# Function to extract transactions for a specified activity
transactions_extract <- function(iati_id, page) {
path <- paste0("https://iati.cloud/api/transactions/?iati_identifier=", iati_id, "&fields=value,transaction_date,description,currency,receiver_organisation&format=json&page_size=20&page=", page)
request <- GET(url = path)
response <- content(request, as = "text", encoding = "UTF-8")
response <- fromJSON(response, flatten = TRUE)
new_data <- response$results
results <- plyr::rbind.fill(transaction_list, new_data)
return(results)
}
# Prepare results data frame and counters
transaction_list <- data.frame()
new_rows <- 0
page <- 1
# Run extraction, stopping when no new transactions are returned
for (id in id_list) {
new_rows <- 0
page <- 1
while (page == 1 | new_rows > 0) {
print(paste0(id, "-", page))
x <- nrow(transaction_list)
transaction_list <- transactions_extract(id, page)
page <- page + 1
y <- nrow(transaction_list)
new_rows = y - x
}
}
# B) Unnest information -----
transactions_unnest <- transaction_list %>%
rename(currency = currency.code) %>%
# 1 - Country
unnest(cols = recipient_countries,
keep_empty = TRUE) %>%
select(-country.url, -country.code, -recipient_countries, -recipient_regions) %>%
rename(recipient_country = country.name) %>%
# 2 - Description
unnest(cols = description.narrative,
keep_empty = TRUE) %>%
select(-lang.code, -lang.name) %>%
rename(title = text) %>%
# 3 - Sectors
unnest(cols = sectors,
keep_empty = TRUE) %>%
rename(subject = sector.name) %>%
# 4 - Receiver org
unnest(cols = receiver_organisation.narrative,
keep_empty = TRUE) %>%
mutate(lead_org_name = coalesce(text, receiver_organisation.ref)) %>%
filter(!is.na(lead_org_name)) %>%   # remove transactions without a recipient
filter(!(lead_org_name == "Elrha")) %>%  # remove Elrha income
# select fields to keep
select(iati_identifier, start_date = transaction_date,
title, recipient_country, subject, currency, amount = value, lead_org_name) %>%
# sum amounts over multiple payments
group_by(iati_identifier, title, recipient_country, currency, subject, lead_org_name) %>%
summarise(start_date = min(start_date),
amount = sum(as.numeric(amount))) %>%
unique() %>%
mutate(partner_org_name = "",
partner_org_country = "",
lead_org_country = "",
end_date = "",
last_updated = quarter_end_date)
# C) Join information back to master dataset ----
# Read in R file (from previous script)
all_projects <- readRDS("Outputs/all_projects.rds")
# Subset for transaction based activities
all_projects_subset <- all_projects %>%
filter(id %in% id_list) %>%
select(id, abstract, extending_org, iati_id, Fund, Funder, status, link) %>%
unique() %>%
left_join(transactions_unnest, by = c("id" = "iati_identifier"))
all_projects_subset$id_suffix <- seq.int(nrow(all_projects_subset))
all_projects_subset <- all_projects_subset %>%
mutate(id = paste0(id, "-", id_suffix)) %>%
select(-id_suffix)
# Replace original single line activities in master file
all_projects_transactions <- all_projects %>%
filter(!(id %in% id_list)) %>%
rbind(all_projects_subset)
# D) Save information ----
saveRDS(all_projects_transactions, file = "Outputs/all_projects_transactions.rds")
# Restore the object
# all_projects_transactions <- readRDS(file = "Outputs/all_projects_transactions.rds")
# E) Check ----
test <- filter(all_projects_transactions, str_detect(extending_org, "Abdul"))
test <- filter(all_projects_transactions, str_detect(id, "MR/N006267/1"))
# check id field is unique
length(unique(all_projects_transactions$id))
transactions_unnest <- transaction_list %>%
rename(currency = currency.code) %>%
# 1 - Country
unnest(cols = recipient_countries,
keep_empty = TRUE) %>%
select(-country.url, -country.code, -recipient_countries, -recipient_regions) %>%
rename(recipient_country = country.name) %>%
# 2 - Description
unnest(cols = description.narrative,
keep_empty = TRUE) %>%
select(-lang.code, -lang.name) %>%
rename(title = text) %>%
# 3 - Sectors
unnest(cols = sectors,
keep_empty = TRUE) %>%
rename(subject = sector.name) %>%
# 4 - Receiver org
unnest(cols = receiver_organisation.narrative,
keep_empty = TRUE) %>%
mutate(lead_org_name = coalesce(text, receiver_organisation.ref)) %>%
filter(!is.na(lead_org_name)) %>%   # remove transactions without a recipient
filter(!(lead_org_name == "Elrha")) %>%  # remove Elrha income
# select fields to keep
select(iati_identifier, start_date = transaction_date,
title, recipient_country, subject, currency, amount = value, lead_org_name) %>%
# sum amounts over multiple payments
group_by(iati_identifier, title, recipient_country, currency, subject, lead_org_name) %>%
summarise(start_date = min(start_date),
amount = sum(as.numeric(amount))) %>%
unique() %>%
mutate(partner_org_name = "",
partner_org_country = "",
period_start = "",
period_end = "",
lead_org_country = "",
end_date = "",
last_updated = quarter_end_date)
# Read in R file (from previous script)
all_projects <- readRDS("Outputs/all_projects.rds")
# Subset for transaction based activities
all_projects_subset <- all_projects %>%
filter(id %in% id_list) %>%
select(id, abstract, extending_org, iati_id, Fund, Funder, status, link) %>%
unique() %>%
left_join(transactions_unnest, by = c("id" = "iati_identifier"))
all_projects_subset$id_suffix <- seq.int(nrow(all_projects_subset))
all_projects_subset <- all_projects_subset %>%
mutate(id = paste0(id, "-", id_suffix)) %>%
select(-id_suffix)
# Replace original single line activities in master file
all_projects_transactions <- all_projects %>%
filter(!(id %in% id_list)) %>%
rbind(all_projects_subset)
saveRDS(all_projects_transactions, file = "Outputs/all_projects_transactions.rds")
if (!("googlesheets4" %in% installed.packages())) {
install.packages("googlesheets4")
}
if (!("gargle" %in% installed.packages())) {
install.packages("gargle")
}
if (!("jsonlite" %in% installed.packages())) {
install.packages("jsonlite")
}
if (!("tidyverse" %in% installed.packages())) {
install.packages("tidyverse")
}
# Load packages -----
library(jsonlite)
#library(stringi)
library(googlesheets4)
library(gargle)
#library(httr)
library(tidyverse)
# Read in data from script 4
all_projects_transactions <- readRDS(file = "Outputs/all_projects_transactions.rds")
# Distinguish location and beneficiary countries in main dataset
all_projects_final <- all_projects_transactions %>%
mutate(location_country = paste0(coalesce(lead_org_country, ""), ", ", coalesce(partner_org_country, "")),
beneficiary_country = recipient_country)
# Convert location vs. beneficiary country data to long format
countries_data <- all_projects_final %>%
select(id, beneficiary_country, location_country) %>%
gather(key = "country_type", value = "Country", -id) %>%
right_join(select(all_projects_final, -beneficiary_country, -location_country), by = "id")
# Create one row per country
all_projects_split_country <- countries_data %>%
select(id, extending_org, country_type, Country) %>%
mutate(Country = str_replace_all(Country, "Tanzania, United Republic Of|Tanzania, United Republic of", "Tanzania")) %>%
mutate(Country = str_replace_all(Country, ";", ",")) %>%
mutate(Country = gsub("\\s*\\([^\\)]+\\)","", as.character(Country))) %>%
separate_rows(Country, sep = ",", convert = FALSE) %>%
mutate(Country = str_trim(Country)) %>%
mutate(Country = str_replace_all(Country, c("UK|Scotland|Wales|United kingdom|England|Northern Ireland|UNITED KINGDOM"), "United Kingdom"),
Country = str_replace_all(Country, c("USA|UNITED STATES|United states"), "United States"),
Country = str_replace(Country, "N/A", "Unknown"),
Country = str_replace(Country, "The Netherlands", "Netherlands"),
Country = str_replace(Country, "The Philippines", "Philippines"),
Country = if_else(str_detect(Country, "Ivoire"), "Ivory Coast", Country),
Country = str_replace(Country, "Republic of Congo", "Congo Republic"),
Country = str_replace(Country, "DRC", "Democratic Republic of the Congo"),
Country = if_else(str_detect(Country, "Hong Kong"), "Hong Kong", Country)) %>%
unique() %>%
filter(!(Country %in% c("", "NA", "Unknown")) & !is.na(Country)) %>%
arrange(id)
# Create one row per country
all_projects_split_country <- countries_data %>%
select(id, extending_org, country_type, Country) %>%
mutate(Country = str_replace_all(Country, "Tanzania, United Republic Of|Tanzania, United Republic of", "Tanzania"),
Country = str_replace_all(Country, "Congo, Democratic Republic of", "Democratic Republic of the Congo")) %>%
mutate(Country = gsub("\\s*\\([^\\)]+\\)","", as.character(Country))) %>%
separate_rows(Country, sep = ",|;|/", convert = FALSE) %>%
mutate(Country = str_trim(Country),
Country = if_else(str_detect(tolower(Country), "uk|united kingdom|england|northern ireland|wales|scotland"), "United Kingdom", Country),
Country = if_else(str_detect(tolower(Country), "usa|united states"), "United States", Country),
Country = if_else(str_detect(tolower(Country), "netherlands"), "Netherlands", Country),
Country = if_else(str_detect(tolower(Country), "philippines"), "Philippines", Country),
Country = if_else(str_detect(tolower(Country), "ivoire"), "Ivory Coast", Country)) %>%
unique() %>%
filter(!(Country %in% c("", "NA", "Unknown")) & !is.na(Country)) %>%
arrange(id)
# Read in DAC country lookup and Tableau accepted country list
dac_lookup <- read_xlsx("Inputs/Country lookup - Tableau and DAC Income Group.xlsx")
# Check countries that are unmatched (this information will be lost)
unmatched_countries <- all_projects_split_country %>%
filter(!(Country %in% dac_lookup$country_name)) %>%
select(Country) %>%
unique()
# Replace country with "Unknown" if not recognised against Tableau's
# accepted list
all_projects_split_country <- all_projects_split_country %>%
mutate(Country = if_else(Country %in% dac_lookup$country_name, Country, "Unknown")) %>%
unique()
# Join countries to project data
all_projects_final <- countries_data %>%
# remove commas at start
mutate(Country = if_else(substr(Country, 1, 1) == ",", substr(Country, 2, length(Country)-1), Country)) %>%
rename(all_countries = Country) %>%
left_join(all_projects_split_country, by = c("id", "extending_org", "country_type"))
# Add row ID field to dataset
all_projects_final$row_id <- seq.int(nrow(all_projects_final))
# Extract project records with unknown or missing country field
missing_country_projects <- filter(all_projects_final,
Country %in% c("Unknown") | is.na(Country)) %>%
select(row_id, id, country_type) %>%
unique() %>%
mutate(exclude_flag = 1)
# Identify projects that have both a populated and missing country field
duplicate_country_projects <- filter(all_projects_final,
!(Country %in% c("Unknown") | is.na(Country))) %>%
select(row_id, id, country_type) %>%
unique() %>%
filter(id %in% missing_country_projects$id)
# Exclude project records with unknown/missing location or beneficiary country AND
# a populated other country record
all_projects_tidied <- all_projects_final %>%
left_join(missing_country_projects, by = c("row_id", "id", "country_type")) %>%
filter(!(exclude_flag == 1 & country_type == "beneficiary_country" & (Country %in% c("Unknown") | is.na(Country))))
# Label unknown/missing countries as "Unknown" to remove NULLs from Tableau map
all_projects_tidied <- all_projects_tidied %>%
mutate(Country = if_else(is.na(Country), "Unknown", Country)) %>%
select(-exclude_flag)
# Add FCDO programme ID
all_projects_tidied <- all_projects_tidied %>%
# remove any text before "-1-" in the FCDO IATI ID
mutate(fcdo_programme_id = if_else(Funder == "Foreign, Commonwealth and Development Office"
& str_detect(iati_id, "-1-"),
sub(".*-1-", "", iati_id), "")) %>%
# remove any FCDO component numbers
mutate(fcdo_programme_id = sub("-.*", "", fcdo_programme_id))
# Create vector of FCDO gov funder programme IATI IDs
gov_funder_iati_ids <- all_projects_tidied %>%
select(iati_id) %>%
filter(str_detect(iati_id, "GB-1-|GB-GOV-1-")) %>%
unique()
extract_iati_activity_name <- function(activity_id) {
path <- paste0("https://iati.cloud/api/activities/?iati_identifier=", activity_id, "&format=json&fields=title")
request <- GET(url = path)
response <- content(request, as = "text", encoding = "UTF-8")
response <- fromJSON(response, flatten = TRUE)
new_data <- response$results
if(length(new_data) > 0) {
new_data <- new_data %>%
unnest(col = title.narrative) %>%
select(funder_iati_id = iati_identifier, funder_programme = text)
} else {
new_data <- data.frame()
}
return(new_data)
}
# Create empty dataframe to hold name extract from IATI
gov_funder_programme_names <- data.frame()
for (id in gov_funder_iati_ids$iati_id) {
print(id)
data <- extract_iati_activity_name(id)
gov_funder_programme_names <- rbind(gov_funder_programme_names, data)
}
# Join funder programme name to main dataset
all_projects_tidied <- all_projects_tidied %>%
left_join(gov_funder_programme_names, by = c("iati_id" = "funder_iati_id"))
all_projects_tidied <- all_projects_tidied %>%
mutate(Fund = if_else(str_detect(Fund, "FCDO Research"), "FCDO fully funded", Fund),
Funder = if_else(str_detect(Funder, "Foreign, Commonwealth & Development Office|FCDO"), "Foreign, Commonwealth and Development Office", Funder))
all_projects_tidied <- all_projects_tidied %>%
mutate(Funder = if_else(Funder == "National Institutes of Health", "Department of Health and Social Care", Funder),
lead_org_country = if_else(Fund == "Chevening Scholarships", "United Kingdom", lead_org_country))
# TEMPORARY ***
# Remove IDRC DHSC IATI data
all_projects_tidied <- all_projects_tidied %>%
filter(!(Funder == "Department of Health and Social Care" & extending_org == "International Development Research Centre"))
# check list of ODA R&I funds
unique(all_projects_tidied$Fund)
test <- filter(all_projects_tidied, is.na(Fund))
nrow(test)
# check list of ODA R&I funders
unique(all_projects_tidied$Funder)
test <- filter(all_projects_tidied, is.na(Funder))
# Check countries
unique(all_projects_tidied$Country)
test <- filter(all_projects_tidied,
is.na(Country) | str_detect(Country, ","))
test2 <- filter(all_projects_tidied,
Country == "Unknown")
test3 <- filter(all_projects_tidied,
Country == "Niger")
# Unknown country should be for the activity location only
unique(test2$country_type)
# Write to RDS
saveRDS(all_projects_tidied, "Outputs/all_projects_tidied.rds")
# Limit size and number of columns for writing
all_projects_tidied <- all_projects_tidied %>%
# select(-subject, -all_countries, -last_updated) %>%
mutate(country_type = if_else(country_type == "beneficiary_country", 1, 2)) %>%
unique()
# Remove Afghanistan projects
all_projects_tidied <- all_projects_tidied %>%
filter(Country != "Afghanistan")
ODA_RI_url <- "https://docs.google.com/spreadsheets/d/1ByVBWb3LNSoqAUzKlddd537DleQ-y9MINwY_SuuZEbY/edit#gid=2024786204"
results <- as_sheets_id(ODA_RI_url)
results_sheet <- sheet_write(all_projects_tidied,
ss = results,
sheet = "ODA_RI_projects")
