) %>%
select(-`No.`, -`Funder programme - name`, -Notes, -file_number, -Currency,
-`Aims/Objectives`, -`Investigator(s) - name`, -`FCDO programme - name`,
-`FCDO programme - IATI ID`, -Link)
# Save as R file (to read back in if needed)
saveRDS(collated_spreadsheet_data, file = "Outputs/collated_spreadsheet_data.rds")
rm(partner_spreadsheet_data)
rm(partner_iati_list)
rm(data_list)
rm(file_list)
rm(n)
rm(id)
# Reformat to match other datasetS
roda_extract_gcrf_final <- roda_extract_gcrf %>%
rename(id = `Extending organisation - award ID`,
abstract = `Award description`,
title = `Award title`,
start_date = `Start date`,
end_date = `End date`,
amount = `Award amount (£)`,
recipient_country = `Beneficiary country`,
extending_org = `Extending organisation - name`,
lead_org_name = `Lead organisation - name`,
lead_org_country = `Lead organisation - country`,
partner_org_name = `Implementing partner(s) - name`,
partner_org_country = `Implementing partner(s) - country`,
iati_id = `Funder programme - IATI ID`,
link = `Data source`
) %>%
mutate(start_date = as.character(start_date),
end_date = as.character(end_date),
currency = coalesce(Currency, "GDP"),
status = if_else(`Status` %in% c("Spend in progress", "Agreement in place", "Delivery", "Finalisation"), "Active",
if_else(`Status` %in% c("Completed"), "Closed",
if_else(`Status` %in% c("Cancelled"), "Cancelled", "Unknown"))),
period_start = "",
period_end = "",
subject = "",
last_updated = quarter_end_date
) %>%
select(-`No.`, -Currency, -`Aims/Objectives`, -`Investigator(s) - name`,  -Status)
# BEIS RODA GCRF/Newton extracts
roda_extract_gcrf <- read_excel("Inputs/BEIS RODA - GCRF non-UKRI Q1-21-22.xlsx", sheet = 2)
roda_extract_newton <- read_excel("Inputs/BEIS_NF_MODARI_Q1_2021-2022.xlsx")
# Reformat to match other datasetS
roda_extract_gcrf_final <- roda_extract_gcrf %>%
rename(id = `Extending organisation - award ID`,
abstract = `Award description`,
title = `Award title`,
start_date = `Start date`,
end_date = `End date`,
amount = `Award amount (£)`,
recipient_country = `Beneficiary country`,
extending_org = `Extending organisation - name`,
lead_org_name = `Lead organisation - name`,
lead_org_country = `Lead organisation - country`,
partner_org_name = `Implementing partner(s) - name`,
partner_org_country = `Implementing partner(s) - country`,
iati_id = `Funder programme - IATI ID`,
link = `Data source`
) %>%
mutate(start_date = as.character(start_date),
end_date = as.character(end_date),
currency = coalesce(Currency, "GDP"),
status = if_else(`Status` %in% c("Spend in progress", "Agreement in place", "Delivery", "Finalisation"), "Active",
if_else(`Status` %in% c("Completed"), "Closed",
if_else(`Status` %in% c("Cancelled"), "Cancelled", "Unknown"))),
period_start = "",
period_end = "",
subject = "",
last_updated = quarter_end_date
) %>%
select(-`No.`, -Currency, -`Aims/Objectives`, -`Investigator(s) - name`,  -Status)
roda_extract_newton_final <- roda_extract_newton %>%
rename(id = ID,
title = Title,
abstract = Description,
amount = `Value (Indicative)`,
recipient_country = `Recipient country`,
extending_org = `Lead Organisation`) %>%
mutate(Fund = "Newton Fund",
Funder = "Department for Business, Energy and Industrial Strategy",
lead_org_name = "",
lead_org_country = "",
partner_org_name = "",
partner_org_country = "",
iati_id = "",
link = "",
start_date = as.character(coalesce(`Actual start date`, `Planned start date`)),
end_date = as.character(coalesce(`Actual end date`, `Planned end date`)),
currency = "GDP",
period_start = "",
period_end = "",
subject = "",
last_updated = quarter_end_date
) %>%
mutate(status = if_else(!is.na(end_date),
if_else(Sys.Date() <= end_date, "Active", "Closed"), "Unknown")) %>%
select(-`Delivery partner`, -`Recipient region`, -`Planned start date`,
-`Planned end date`, -`Actual start date`, -`Actual end date`)
roda_extract_newton_final <- roda_extract_newton %>%
rename(id = ID,
title = Title,
abstract = Description,
amount = `Value (Indicative)`,
recipient_country = `Recipient country`,
extending_org = `Lead Organisation`) %>%
mutate(Fund = "Newton Fund",
Funder = "Department for Business, Energy and Industrial Strategy",
lead_org_name = "",
lead_org_country = "",
partner_org_name = "",
partner_org_country = "",
iati_id = "",
link = "",
start_date = as.character(coalesce(`Actual start date`, `Planned start date`)),
end_date = as.character(coalesce(`Actual end date`, `Planned end date`)),
currency = "GDP",
period_start = "",
period_end = "",
subject = "",
last_updated = quarter_end_date) %>%
# mutate(status = if_else(!is.na(end_date),
#                       if_else(Sys.Date() <= end_date, "Active", "Closed"), "Unknown")) %>%
select(-`Delivery partner`, -`Recipient region`, -`Planned start date`,
-`Planned end date`, -`Actual start date`, -`Actual end date`)
roda_extract_newton_final <- roda_extract_newton %>%
rename(id = ID,
title = Title,
abstract = Description,
amount = `Value (Indicative)`,
recipient_country = `Recipient country`,
extending_org = `Lead Organisation`) %>%
mutate(Fund = "Newton Fund",
Funder = "Department for Business, Energy and Industrial Strategy",
lead_org_name = "",
lead_org_country = "",
partner_org_name = "",
partner_org_country = "",
iati_id = "",
link = "",
start_date = coalesce(`Actual start date`, `Planned start date`),
end_date = coalesce(`Actual end date`, `Planned end date`),
currency = "GDP",
period_start = "",
period_end = "",
subject = "",
last_updated = quarter_end_date) %>%
mutate(status = if_else(!is.na(end_date),
if_else(Sys.Date() <= end_date, "Active", "Closed"), "Unknown")) %>%
select(-`Delivery partner`, -`Recipient region`, -`Planned start date`,
-`Planned end date`, -`Actual start date`, -`Actual end date`)
roda_extract_newton_final <- roda_extract_newton %>%
rename(id = ID,
title = Title,
abstract = Description,
amount = `Value (Indicative)`,
recipient_country = `Recipient country`,
extending_org = `Lead Organisation`) %>%
mutate(Fund = "Newton Fund",
Funder = "Department for Business, Energy and Industrial Strategy",
lead_org_name = "",
lead_org_country = "",
partner_org_name = "",
partner_org_country = "",
iati_id = "",
link = "",
start_date = coalesce(`Actual start date`, `Planned start date`),
end_date = coalesce(`Actual end date`, `Planned end date`),
currency = "GDP",
period_start = "",
period_end = "",
subject = "",
last_updated = quarter_end_date) %>%
# mutate(status = if_else(!is.na(end_date),
#                       if_else(Sys.Date() <= end_date, "Active", "Closed"), "Unknown")) %>%
select(-`Delivery partner`, -`Recipient region`, -`Planned start date`,
-`Planned end date`, -`Actual start date`, -`Actual end date`)
roda_extract_newton_final <- roda_extract_newton %>%
rename(id = ID,
title = Title,
abstract = Description,
amount = `Value (Indicative)`,
recipient_country = `Recipient country`,
extending_org = `Lead Organisation`) %>%
mutate(Fund = "Newton Fund",
Funder = "Department for Business, Energy and Industrial Strategy",
lead_org_name = "",
lead_org_country = "",
partner_org_name = "",
partner_org_country = "",
iati_id = "",
link = "",
start_date = as.date(coalesce(`Actual start date`, `Planned start date`)),
end_date = coalesce(`Actual end date`, `Planned end date`),
currency = "GDP",
period_start = "",
period_end = "",
subject = "",
last_updated = quarter_end_date) %>%
# mutate(status = if_else(!is.na(end_date),
#                       if_else(Sys.Date() <= end_date, "Active", "Closed"), "Unknown")) %>%
select(-`Delivery partner`, -`Recipient region`, -`Planned start date`,
-`Planned end date`, -`Actual start date`, -`Actual end date`)
roda_extract_newton_final <- roda_extract_newton %>%
rename(id = ID,
title = Title,
abstract = Description,
amount = `Value (Indicative)`,
recipient_country = `Recipient country`,
extending_org = `Lead Organisation`) %>%
mutate(Fund = "Newton Fund",
Funder = "Department for Business, Energy and Industrial Strategy",
lead_org_name = "",
lead_org_country = "",
partner_org_name = "",
partner_org_country = "",
iati_id = "",
link = "",
start_date = as.Date(coalesce(`Actual start date`, `Planned start date`)),
end_date = coalesce(`Actual end date`, `Planned end date`),
currency = "GDP",
period_start = "",
period_end = "",
subject = "",
last_updated = quarter_end_date) %>%
# mutate(status = if_else(!is.na(end_date),
#                       if_else(Sys.Date() <= end_date, "Active", "Closed"), "Unknown")) %>%
select(-`Delivery partner`, -`Recipient region`, -`Planned start date`,
-`Planned end date`, -`Actual start date`, -`Actual end date`)
roda_extract_newton_final <- roda_extract_newton %>%
rename(id = ID,
title = Title,
abstract = Description,
amount = `Value (Indicative)`,
recipient_country = `Recipient country`,
extending_org = `Lead Organisation`) %>%
mutate(Fund = "Newton Fund",
Funder = "Department for Business, Energy and Industrial Strategy",
lead_org_name = "",
lead_org_country = "",
partner_org_name = "",
partner_org_country = "",
iati_id = "",
link = "",
start_date = as.Date(coalesce(`Actual start date`, `Planned start date`), "%dd %mmm %yyyy"),
end_date = coalesce(`Actual end date`, `Planned end date`),
currency = "GDP",
period_start = "",
period_end = "",
subject = "",
last_updated = quarter_end_date) %>%
# mutate(status = if_else(!is.na(end_date),
#                       if_else(Sys.Date() <= end_date, "Active", "Closed"), "Unknown")) %>%
select(-`Delivery partner`, -`Recipient region`, -`Planned start date`,
-`Planned end date`, -`Actual start date`, -`Actual end date`)
roda_extract_newton_final <- roda_extract_newton %>%
rename(id = ID,
title = Title,
abstract = Description,
amount = `Value (Indicative)`,
recipient_country = `Recipient country`,
extending_org = `Lead Organisation`) %>%
mutate(Fund = "Newton Fund",
Funder = "Department for Business, Energy and Industrial Strategy",
lead_org_name = "",
lead_org_country = "",
partner_org_name = "",
partner_org_country = "",
iati_id = "",
link = "",
start_date = as.Date(coalesce(`Actual start date`, `Planned start date`), "%dd%mmm%yyyy"),
end_date = coalesce(`Actual end date`, `Planned end date`),
currency = "GDP",
period_start = "",
period_end = "",
subject = "",
last_updated = quarter_end_date) %>%
# mutate(status = if_else(!is.na(end_date),
#                       if_else(Sys.Date() <= end_date, "Active", "Closed"), "Unknown")) %>%
select(-`Delivery partner`, -`Recipient region`, -`Planned start date`,
-`Planned end date`, -`Actual start date`, -`Actual end date`)
roda_extract_newton_final <- roda_extract_newton %>%
rename(id = ID,
title = Title,
abstract = Description,
amount = `Value (Indicative)`,
recipient_country = `Recipient country`,
extending_org = `Lead Organisation`) %>%
mutate(Fund = "Newton Fund",
Funder = "Department for Business, Energy and Industrial Strategy",
lead_org_name = "",
lead_org_country = "",
partner_org_name = "",
partner_org_country = "",
iati_id = "",
link = "",
start_date = as.Date(coalesce(`Actual start date`, `Planned start date`), "%d %b %y"),
end_date = coalesce(`Actual end date`, `Planned end date`),
currency = "GDP",
period_start = "",
period_end = "",
subject = "",
last_updated = quarter_end_date) %>%
# mutate(status = if_else(!is.na(end_date),
#                       if_else(Sys.Date() <= end_date, "Active", "Closed"), "Unknown")) %>%
select(-`Delivery partner`, -`Recipient region`, -`Planned start date`,
-`Planned end date`, -`Actual start date`, -`Actual end date`)
roda_extract_newton_final <- roda_extract_newton %>%
rename(id = ID,
title = Title,
abstract = Description,
amount = `Value (Indicative)`,
recipient_country = `Recipient country`,
extending_org = `Lead Organisation`) %>%
mutate(Fund = "Newton Fund",
Funder = "Department for Business, Energy and Industrial Strategy",
lead_org_name = "",
lead_org_country = "",
partner_org_name = "",
partner_org_country = "",
iati_id = "",
link = "",
start_date = as.Date(coalesce(`Actual start date`, `Planned start date`), "%d %b %y"),
end_date = as.Date(coalesce(`Actual end date`, `Planned end date`), "%d %b %y"),
currency = "GDP",
period_start = "",
period_end = "",
subject = "",
last_updated = quarter_end_date) %>%
# mutate(status = if_else(!is.na(end_date),
#                       if_else(Sys.Date() <= end_date, "Active", "Closed"), "Unknown")) %>%
select(-`Delivery partner`, -`Recipient region`, -`Planned start date`,
-`Planned end date`, -`Actual start date`, -`Actual end date`)
roda_extract_newton_final <- roda_extract_newton %>%
rename(id = ID,
title = Title,
abstract = Description,
amount = `Value (Indicative)`,
recipient_country = `Recipient country`,
extending_org = `Lead Organisation`) %>%
mutate(Fund = "Newton Fund",
Funder = "Department for Business, Energy and Industrial Strategy",
lead_org_name = "",
lead_org_country = "",
partner_org_name = "",
partner_org_country = "",
iati_id = "",
link = "",
start_date = as.Date(coalesce(`Actual start date`, `Planned start date`), "%d %b %y"),
end_date = as.Date(coalesce(`Actual end date`, `Planned end date`), "%d %b %y"),
currency = "GDP",
period_start = "",
period_end = "",
subject = "",
last_updated = quarter_end_date) %>%
mutate(status = if_else(!is.na(end_date),
if_else(Sys.Date() <= end_date, "Active", "Closed"), "Unknown")) %>%
select(-`Delivery partner`, -`Recipient region`, -`Planned start date`,
-`Planned end date`, -`Actual start date`, -`Actual end date`)
roda_extract_newton_final <- roda_extract_newton %>%
rename(id = ID,
title = Title,
abstract = Description,
amount = `Value (Indicative)`,
recipient_country = `Recipient country`,
extending_org = `Lead Organisation`) %>%
mutate(Fund = "Newton Fund",
Funder = "Department for Business, Energy and Industrial Strategy",
lead_org_name = "",
lead_org_country = "",
partner_org_name = "",
partner_org_country = "",
iati_id = "",
link = "",
start_date = as.character(as.Date(coalesce(`Actual start date`, `Planned start date`), "%d %b %y")),
end_date = as.Date(coalesce(`Actual end date`, `Planned end date`), "%d %b %y"),
currency = "GDP",
period_start = "",
period_end = "",
subject = "",
last_updated = quarter_end_date) %>%
mutate(status = if_else(!is.na(end_date),
if_else(Sys.Date() <= end_date, "Active", "Closed"), "Unknown")) %>%
select(-`Delivery partner`, -`Recipient region`, -`Planned start date`,
-`Planned end date`, -`Actual start date`, -`Actual end date`)
roda_extract_newton_final <- roda_extract_newton %>%
rename(id = ID,
title = Title,
abstract = Description,
amount = `Value (Indicative)`,
recipient_country = `Recipient country`,
extending_org = `Lead Organisation`) %>%
mutate(Fund = "Newton Fund",
Funder = "Department for Business, Energy and Industrial Strategy",
lead_org_name = "",
lead_org_country = "",
partner_org_name = "",
partner_org_country = "",
iati_id = "",
link = "",
start_date = as.character(as.Date(coalesce(`Actual start date`, `Planned start date`), "%d %b %y")),
end_date = as.character(as.Date(coalesce(`Actual end date`, `Planned end date`), "%d %b %y")),
currency = "GDP",
period_start = "",
period_end = "",
subject = "",
last_updated = quarter_end_date) %>%
mutate(status = if_else(!is.na(end_date),
if_else(Sys.Date() <= end_date, "Active", "Closed"), "Unknown")) %>%
select(-`Delivery partner`, -`Recipient region`, -`Planned start date`,
-`Planned end date`, -`Actual start date`, -`Actual end date`)
rm(roda_extract_gcrf)
rm(roda_extract_newton)
all_projects <- rbind(ukri_projects_final, nihr_projects_final,
iati_projects_final, wellcome_grants_final,
collated_spreadsheet_data,
roda_extract_gcrf_final, roda_extract_newton_final)
# Save as R file (to read back in if needed)
saveRDS(all_projects, file = "Outputs/all_projects.rds")
# Read in data from script 3
all_projects <- readRDS("Outputs/all_projects.rds")
# Distinguish location and beneficiary countries in main dataset
all_projects_final <- all_projects %>%
mutate(location_country = paste0(coalesce(lead_org_country, ""), ", ", coalesce(partner_org_country, "")),
beneficiary_country = recipient_country)
# Convert location vs. beneficiary country data to long format
countries_data <- all_projects_final %>%
select(id, beneficiary_country, location_country) %>%
gather(key = "country_type", value = "Country", -id) %>%
right_join(select(all_projects_final, -beneficiary_country, -location_country), by = "id")
# Convert dataset to long with one row per country entry
all_projects_split_country <- countries_data %>%
select(id, extending_org, country_type, Country) %>%
mutate(Country = str_replace_all(Country, "Tanzania, United Republic Of|Tanzania, United Republic of", "Tanzania")) %>%
mutate(Country = str_replace_all(Country, ";", ",")) %>%
mutate(Country = gsub("\\s*\\([^\\)]+\\)","", as.character(Country))) %>%
separate_rows(Country, sep = ",", convert = FALSE)
# Clean country field
all_projects_split_country <- all_projects_split_country %>%
mutate(Country = str_trim(Country)) %>%
mutate(Country = str_replace_all(Country, c("UK|Scotland|Wales|United kingdom|England|Northern Ireland|UNITED KINGDOM"), "United Kingdom"),
Country = str_replace_all(Country, c("USA|UNITED STATES|United states"), "United States"),
Country = str_replace(Country, "N/A", "Unknown"),
Country = str_replace(Country, "The Netherlands", "Netherlands"),
Country = str_replace(Country, "The Philippines", "Philippines"),
Country = if_else(str_detect(Country, "Ivoire"), "Ivory Coast", Country),
Country = str_replace(Country, "Republic of Congo", "Congo Republic"),
Country = str_replace(Country, "DRC", "Democratic Republic of the Congo"),
Country = if_else(str_detect(Country, "Hong Kong"), "Hong Kong", Country)) %>%
unique() %>%
filter(!(Country %in% c("", "NA", "Unknown")) & !is.na(Country)) %>%
arrange(id)
# Check countries that are unmatched (this information will be overwritten)
unmatched_countries <- all_projects_split_country %>%
filter(!(Country %in% dac_lookup$country_name)) %>%
select(Country) %>%
unique()
# Replace country with "Unknown" if not recognised against Tableau's accepted list
all_projects_split_country <- all_projects_split_country %>%
mutate(Country = if_else(Country %in% dac_lookup$country_name, Country, "Unknown")) %>%
unique()
# Join countries to project data
all_projects_final <- countries_data %>%
# remove commas at start
mutate(Country = if_else(substr(Country, 1, 1) == ",", substr(Country, 2, length(Country)-1), Country)) %>%
rename(all_countries = Country) %>%
left_join(all_projects_split_country, by = c("id", "extending_org", "country_type"))
# Add row ID field to dataset
all_projects_final$row_id <- seq.int(nrow(all_projects_final))
# Extract project records with unknown or missing country field
missing_country_projects <- filter(all_projects_final,
Country %in% c("Unknown") | is.na(Country)) %>%
select(row_id, id) %>%
unique() %>%
mutate(exclude_flag = 1)
# Identify projects that have both a populated and missing country field
duplicate_country_projects <- filter(all_projects_final,
!(Country %in% c("Unknown") | is.na(Country))) %>%
select(row_id, id) %>%
unique() %>%
filter(id %in% missing_country_projects$id)
View(duplicate_country_projects)
# Extract project records with unknown or missing country field
missing_country_projects <- filter(all_projects_final,
Country %in% c("Unknown") | is.na(Country)) %>%
select(row_id, id) %>%
unique()
# Identify projects that have both a populated and missing country field
duplicate_country_projects <- filter(all_projects_final,
!(Country %in% c("Unknown") | is.na(Country))) %>%
select(row_id, id) %>%
unique() %>%
filter(id %in% missing_country_projects$id)  %>%
mutate(exclude_flag = 1)
# Exclude project records for "Unknown" country when the project has other country info
all_projects_tidied <- all_projects_final %>%
left_join(duplicate_country_projects, by = c("row_id", "id")) %>%
filter(!(exclude_flag == 1 &
(Country == "Unknown" | is.na(Country))
)) %>%
select(-exclude_flag)
# check list of ODA R&I funds
table(all_projects_tidied$Fund)
# check list of ODA R&I funders
table(all_projects_tidied$Funder)
test3 <- filter(all_projects, str_detect(Funder, "Rural"))
View(test3)
# check list of ODA R&I funders
table(all_projects_final$Funder)
# check list of ODA R&I funders
table(all_projects_tidied$Funder)
