mutate(final_country = coalesce(grid_country, name_country))
result <- str_to_title((country_lookup$final_country)[1])
return(result)
}
# Test
# org_name <- "International Development Research Centre"
# org_country_lookup(org_name)
### IATI ###
# Function to extract 5-digit OECD sector codes
sector_extract <- function(page, sector_list) {
path <- paste0("https://iati.cloud/api/sectors/?fields=category,url,name,code&format=json&page_size=20&page=", page)
request <- GET(url = path)
response <- content(request, as = "text", encoding = "UTF-8")
response <- fromJSON(response, flatten = TRUE)
# Condition to check when 5-digit codes stop being returned
if(!("category" %in% names(response$results))) {
sector_list <- rbind(sector_list, response$results)
} else {
sector_list <- sector_list
}
return(sector_list)
}
# Function to extract IATI activity info from activity ID
iati_activity_extract <- function(activity_id) {
# Reformat ID if it contains spaces (for API)
activity_id <- str_replace_all(activity_id, " ", "%20")
path <- paste0("https://iati.cloud/api/activities/?iati_identifier=", activity_id, "&format=json&fields=other_identifier,reporting_org,location,default_flow_type,activity_date,budget,policy_marker,activity_status,hierarchy,title,description,participating_org,related_activity&page_size=20")
request <- GET(url = path)
response <- content(request, as = "text", encoding = "UTF-8")
response <- fromJSON(response, flatten = TRUE)
new_data <- response$results
# Ensure "default flow type" field exists for joining datasets
if("default_flow_type.name" %in% names(new_data)) {
new_data <- new_data %>%
mutate(default_flow_type = default_flow_type.name) %>%
select(-default_flow_type.name, -default_flow_type.code)
}
return(new_data)
}
# Function to extract IATI activity IDs for a specified org code
# Error with this CGIAR page
# org_code <- "XM-DAC-47015"
# page <- 77
org_activity_extract <- function(page, org_code, org_activity_list) {
path <- paste0("https://iati.cloud/api/activities/?format=json&reporting_org_identifier=", org_code, "&fields=iati_identifier,other_identifier,activity_date,reporting_org,sector,location,default_flow_type,budget,policy_marker,activity_status,hierarchy,title,description,participating_org,related_activity,tag&page_size=20&page=", page)
request <- GET(url = path)
response <- content(request, as = "text", encoding = "UTF-8")
response <- fromJSON(response, flatten = TRUE)
new_data <- response$results
# Ensure "default flow type" field exists for joining datasets
if("default_flow_type.name" %in% names(new_data)) {
new_data <- new_data %>%
mutate(default_flow_type = default_flow_type.name) %>%
select(-default_flow_type.name, -default_flow_type.code)
}
results <- rbind(org_activity_list, new_data)
return(results)
}
# Function to extract transactions for a specified IATI activity ID
transactions_extract <- function(activity_id, page, output_data) {
# Reformat ID if it contains spaces (for API)
activity_id <- str_replace_all(activity_id, " ", "%20")
path <- paste0("https://iati.cloud/api/transactions/?iati_identifier=", activity_id, "&fields=value,transaction_date,description,currency,receiver_organisation&format=json&page_size=20&page=", page)
request <- GET(url = path)
response <- content(request, as = "text", encoding = "UTF-8")
response <- fromJSON(response, flatten = TRUE)
new_data <- response$results
if(length(new_data) > 0) {
output <- plyr::rbind.fill(output_data, new_data)
} else {
output <- output_data
}
return(output)
}
# Function to extract programme names from IATI
extract_iati_activity_name <- function(activity_id) {
# Reformat ID if it contains spaces (for API)
activity_id <- str_replace_all(activity_id, " ", "%20")
path <- paste0("https://iati.cloud/api/activities/?iati_identifier=", activity_id, "&format=json&fields=title")
request <- GET(url = path)
response <- content(request, as = "text", encoding = "UTF-8")
response <- fromJSON(response, flatten = TRUE)
new_data <- response$results
if(length(new_data) > 0) {
new_data <- new_data %>%
unnest(col = title.narrative) %>%
select(funder_iati_id = iati_identifier, funder_programme = text)
} else {
new_data <- data.frame()
}
return(new_data)
}
### UKRI ###
# 1 - Function to extract project IDs by fund name (GCRF/Newton)
extract_ukri_projects_by_fund <- function(page, fund) {
path <- paste0("https://gtr.ukri.org:443/gtr/api/projects?q=",
fund, "&f=pro.rcukp&p=", page, "&s=100")
request <- GET(url = path)
response <- content(request, as = "text", encoding = "UTF-8")
response <- fromJSON(response, flatten = TRUE)
projects <- response$project
return(projects)
}
# 2 - Function to extract staff organisation
# person_id <- "6E394347-A44B-4868-8EC3-06CA4D034BDA"
extract_staff_org <- function(staff_data, person_id) {
path <- paste0("http://gtr.ukri.org/person/", person_id)
request <- GET(url = path)
response <- content(request, as = "text", encoding = "UTF-8")
response <- fromJSON(response, flatten = TRUE)
person_current_org_name <- ((response$personOverview)$organisation)$name
person_current_org_id <- ((response$personOverview)$organisation)$id
staff_org_data <- rbind(staff_data, data.frame(person_id,
person_current_org_name,
person_current_org_id))
return(staff_org_data)
}
# 3 - Function to extract country from organisation ID
# (checking GRID database as well as UKRI)
# org_id <- "C3F01E23-4A38-46BD-B3CE-8983CE6DBF36"
extract_org_country <- function(org_id) {
path <- paste0("http://gtr.ukri.org/organisation/", org_id)
request <- GET(url = path)
response <- content(request, as = "text", encoding = "UTF-8")
response <- fromJSON(response, flatten = TRUE)
org_name <- ((response$organisationOverview)$organisation)$name
# Look up country from UKRI GtR
org_address <- ((response$organisationOverview)$organisation)$address
if("country" %in% names(org_address)) {
org_country_ukri <- org_address$country
} else {
org_country_ukri <- "Unknown"
}
# If unknown use other generic lookup function
if(org_country_ukri == "Unknown") {
org_country <- org_country_lookup(org_name)
} else {
org_country <- org_country_ukri
}
return(org_country)
}
# 4 - Master function to extract UKRI project data by ID
# id <- "NE/W502662/1"
extract_ukri_projects_by_id <- function(id) {
path <- paste0("http://gtr.ukri.org/projects?ref=", id)
request <- GET(url = path)
response <- content(request, as = "text", encoding = "UTF-8")
response <- fromJSON(response, flatten = TRUE)
# extract project data and last refresh date
data <- response$projectOverview
last_updated <- (response$lastRefreshDate)$lastRefreshDate %>%
str_replace_all("Data last updated:  ", "") %>%
as.Date(format = "%d %b %Y")
if(length(data) > 0) {
# Unlist first level
data <- data$projectComposition
# Extract project, lead org and co-investigator staff ids
projects <- data$project
lead_org <- data$leadResearchOrganisation
person_roles <- data$personRole
# Extract staff information (if applicable)
if(length(person_roles) > 0) {                        # checks length of list
person_roles <- person_roles %>%
unnest(col = role) %>%
filter(name == "CO_INVESTIGATOR") %>%
select(id)
if(nrow(person_roles) > 0) {                # checks no. of rows in dataframe
# Extract current organisation of staff
staff_org_data <- data.frame()
for (person_id in person_roles$id) {
staff_org_data <- extract_staff_org(staff_org_data, person_id)
}
# Join on country of organisation
staff_org_country_data <- staff_org_data %>%
mutate(person_current_org_country = map(person_current_org_id, extract_org_country)) %>%
unnest(col = person_current_org_country)
# Collapse staff partner orgs and countries into single records
if(length(staff_org_country_data$person_current_org_name) > 0) {
staff_org_names <- staff_org_country_data %>%
select(person_current_org_name) %>%
unique() %>%
summarise(partner_name = paste(person_current_org_name, collapse = ", "))
staff_org_countries <- staff_org_country_data %>%
select(person_current_org_country) %>%
filter(person_current_org_country != "Unknown") %>%
unique() %>%
summarise(partner_country = paste(person_current_org_country, collapse = ", "))
org_roles_summarised <- cbind(staff_org_names, staff_org_countries)
}
}
}
# Start constructing project data frame
project_data <- data.frame(
title = projects[["title"]],
status = projects[["status"]],
gtr_id = projects[["grantReference"]],
fund = projects[["fund"]],
abstract = projects[["abstractText"]],
lead_org_name = lead_org[["name"]],
last_updated = as.Date(last_updated))
# Add country of lead org
project_data <- project_data %>%
mutate(lead_org_country = map(lead_org[["id"]], extract_org_country)) %>%
unnest(col = lead_org_country)
# Attach partner org info
if(exists("org_roles_summarised")) {
project_data <- project_data %>%
mutate(partner_org_name = org_roles_summarised$partner_name,
partner_org_country = org_roles_summarised$partner_country)
} else {
project_data <- project_data %>%
mutate(partner_org_name = "",
partner_org_country = "")
}
# Keep desired fields
project_data <- project_data %>%
select(gtr_id, title, abstract, fund.start, fund.end, amount = fund.valuePounds,
extending_org = fund.funder.name,
lead_org_name, lead_org_country, partner_org_name, partner_org_country,
status, last_updated)
} else {
# If no data available to extract, return empty dataframe
project_data <- data.frame()
}
return(project_data)
}
# test <- extract_ukri_projects_by_id(id)
# Read in linked partner IATI activity info from script 1
red_linked_activites <- readRDS(file = "Outputs/red_linked_activites.rds") %>%
rename(iati_id = linked_activity,
funding_iati_id = programme_id)
# Manually add on other (non-linked) partner activities from Excel
iati_activity_ids <- iati_activity_ids %>%
plyr::rbind.fill(red_linked_activites)
partner_activity_extract <- readRDS(file = "Outputs/partner_activity_extract.rds")
partner_activities <- readRDS(file = "Outputs/partner_activities.rds")
partner_activity_extract <- readRDS(file = "Outputs/partner_activity_extract.rds")
# Prepare results data frame and counters
partner_activity_extract <- data.frame()
# Run extraction, stopping when no new sector codes returned
for (id in iati_activity_ids$iati_id) {
print(id)
result <- iati_activity_extract(id)
partner_activity_extract <- rbind(partner_activity_extract, result)
}
# Save to Rdata file
saveRDS(partner_activity_extract, file = "Outputs/partner_activity_extract.rds")
partner_activity_comb <- plyr::rbind.fill(partner_activity_extract, partner_activities) %>%
rename(fcdo_activity_id = activity_id)
# Extract base activity information - hierarchy and status
activity_list_base <- partner_activity_comb %>%
select(iati_identifier, hierarchy,
activity_status = activity_status.name,
flow_type = default_flow_type,
fcdo_activity_id,
gov_funder,
fund) %>%
left_join(select(iati_activity_ids, iati_id, gov_funder), by = c("iati_identifier" = "iati_id")) %>%
mutate(gov_funder = coalesce(gov_funder.x, gov_funder.y)) %>%
select(-gov_funder.x, -gov_funder.y) %>%
unique()
# 1) Unlist activity title and description
activity_list_unnest_1 <- partner_activity_comb %>%
unnest(cols = title.narrative,
keep_empty = TRUE) %>%
filter(lang.name == "English") %>%
select(-lang.code, -lang.name) %>%
rename(activity_title = text) %>%
filter(lengths(description) != 0) %>%
unnest(cols = description,
keep_empty = TRUE) %>%
mutate(type.name = coalesce(type.name, "General")) %>%
select(iati_identifier, activity_title, type.name, narrative) %>%
filter(lengths(narrative) != 0) %>%
unnest(cols = narrative,
keep_empty = TRUE) %>%
filter(lang.name == "English") %>%
unique()
activities_to_fix <- activity_list_unnest_1 %>%
group_by(iati_identifier, activity_title, type.name) %>%
summarise(no_descriptions = n()) %>%
filter(no_descriptions > 1)
activity_list_unnest_1 <- activity_list_unnest_1 %>%
group_by(iati_identifier, activity_title, type.name) %>%
summarise(text = paste(coalesce(text, ""), collapse = "; ")) %>%
spread(key = type.name, value = text)
# 2) Unlist recipient countries
activity_list_unnest_2 <- partner_activity_comb %>%
filter(lengths(recipient_country) != 0) %>%
unnest(cols = recipient_country,
keep_empty = TRUE) %>%
select(iati_identifier, country.name) %>%
group_by(iati_identifier) %>%
unique() %>%
summarise(country_name = paste(coalesce(country.name, ""), collapse = ", "))
# Identify activities without recipient countries at activity level
no_country_info <- partner_activity_comb %>%
filter(lengths(recipient_country) == 0)
# Prepare results data frame and counters
transaction_list <- data.frame()
# Run extraction, stopping when no new transactions are returned
for (id in no_country_info$iati_identifier) {
new_rows <- 0
page <- 1
while (page == 1 | new_rows > 0) {
print(paste0(id, "-", page))
x <- nrow(transaction_list)
transaction_list <- transactions_extract(id, page, transaction_list)
page <- page + 1
y <- nrow(transaction_list)
new_rows = y - x
}
}
transactions_unnest <- transaction_list %>%
filter(lengths(recipient_countries) != 0) %>%
unnest(cols = recipient_countries,
keep_empty = TRUE) %>%
select(-country.url, -recipient_regions) %>%
rename(recipient_country = country.name) %>%
# remove transactions without a country
filter(!is.na(recipient_country)) %>%
# summarise countries
select(iati_identifier, recipient_country) %>%
unique() %>%
group_by(iati_identifier) %>%
summarise(recipient_country = paste(coalesce(recipient_country, ""), collapse = ", "))
# Join on transactions country info to rest of dataset
activity_list_unnest_2_comp <- activity_list_unnest_2 %>%
left_join(transactions_unnest, by = "iati_identifier") %>%
mutate(recipient_country = coalesce(recipient_country, country_name)) %>%
select(-country_name)
# 3) Unlist sectors
activity_list_unnest_3 <- partner_activity_comb %>%
filter(lengths(sector) != 0) %>%
unnest(cols = sector,
keep_empty = TRUE) %>%
select(iati_identifier, sector.code, sector.name, percentage) %>%
mutate(percentage = as.numeric(percentage)) %>%
filter(sector.name != "Vocabulary 99 or 98") %>%
group_by(iati_identifier) %>%
unique()
# Summarise all sector descriptions for each activity
activity_list_unnest_3 <- activity_list_unnest_3 %>%
summarise(sector_code = paste(coalesce(sector.code, ""), collapse = ", "),
sector_name = paste(coalesce(sector.name, ""), collapse = ", "))
# 4) Unlist organisations
activity_list_unnest_4 <- partner_activity_comb %>%
filter(lengths(participating_org) != 0) %>%
unnest(cols = participating_org,
keep_empty = TRUE) %>%
select(iati_identifier, role.name, narrative, ref) %>%
filter(lengths(narrative) != 0,
role.name != "Funding") %>%
unnest(cols = narrative,
keep_empty = TRUE) %>%
filter(lang.name == "English") %>%
select(-lang.code, -lang.name) %>%
unique()
# Add country locations based on IATI references or lookup
activity_list_unnest_4 <- activity_list_unnest_4 %>%
filter(role.name == "Implementing") %>%
mutate(
org_country_iati = case_when(
str_detect(ref, "GB") ~ "United Kingdom",
str_detect(ref, "US") ~ "United States",
str_detect(ref, "NL") ~ "Netherlands",
str_detect(ref, "CA-") ~ "Canada",
str_detect(ref, "IN-") ~ "India",
str_detect(ref, "KE-") ~ "Kenya",
str_detect(ref, "ZA-") ~ "South Africa"),
org_country_other = map(text, org_country_lookup)) %>%
mutate(org_country_other = unlist(org_country_other)) %>%
mutate(org_country = coalesce(org_country_iati, org_country_other)) %>%
select(-org_country_iati, -org_country_other)
# Save implementing orgs with country to file
org_names_and_locations <- activity_list_unnest_4 %>%
select(id = iati_identifier,
org_name = text,
org_country)
View(org_names_and_locations)
# Save implementing orgs with country to file
org_names_and_locations <- activity_list_unnest_4 %>%
select(project_id = iati_identifier,
organisation_name = text,
organisation_country) %>%
mutate(organisation_role = 2)
# Save implementing orgs with country to file
org_names_and_locations <- activity_list_unnest_4 %>%
select(project_id = iati_identifier,
organisation_name = text,
organisation_country = org_country) %>%
mutate(organisation_role = 2)
View(partner_activity_comb)
View(partner_activity_comb[[18]][[1]])
# Collapse implementing orgs
activity_list_unnest_4_partner_names <- activity_list_unnest_4 %>%
select(iati_identifier, text) %>%
filter(!is.na(text)) %>%
unique() %>%
group_by(iati_identifier) %>%
summarise(partner = paste(coalesce(text, ""), collapse = ", "))
activity_list_unnest_4_partner_countries <- activity_list_unnest_4 %>%
select(iati_identifier, org_country) %>%
filter(!is.na(org_country)) %>%
unique() %>%
group_by(iati_identifier) %>%
summarise(partner_country = paste(coalesce(org_country, ""), collapse = ", "))
# Combine in single dataset
activity_list_unnest_4_final <- activity_list_unnest_4 %>%
select(iati_identifier) %>%
unique() %>%
left_join(activity_list_unnest_4_partner_names, by = "iati_identifier") %>%
left_join(activity_list_unnest_4_partner_countries, by = "iati_identifier")
# 5) Unlist publishing org
activity_list_unnest_5 <- partner_activity_comb %>%
filter(lengths(reporting_org.narrative) != 0) %>%
unnest(cols = reporting_org.narrative,
keep_empty = TRUE) %>%
select(iati_identifier, reporting_org_ref = reporting_org.ref,
reporting_org_type = reporting_org.type.name,
reporting_org = text) %>%
# Account for IDRC having names in 3 languages
filter(reporting_org_ref != "XM-DAC-301-2" | reporting_org == "International Development Research Centre") %>%
unique()
# Lookup country
activity_list_unnest_5 <- activity_list_unnest_5 %>%
mutate(
org_country_iati = case_when(
str_detect(reporting_org_ref, "GB") ~ "United Kingdom",
str_detect(reporting_org_ref, "US") ~ "United States",
str_detect(reporting_org_ref, "NL") ~ "Netherlands",
str_detect(reporting_org_ref, "CA-") ~ "Canada",
str_detect(reporting_org_ref, "IN-") ~ "India",
str_detect(reporting_org_ref, "KE-") ~ "Kenya",
str_detect(reporting_org_ref, "ZA-") ~ "South Africa"),
org_country_other = map(reporting_org, org_country_lookup)) %>%
mutate(org_country_other = unlist(org_country_other)) %>%
mutate(reporting_org_country = coalesce(org_country_iati, org_country_other)) %>%
select(-org_country_iati, -org_country_other)
# 5) Unlist publishing org
activity_list_unnest_5 <- partner_activity_comb %>%
filter(lengths(reporting_org.narrative) != 0) %>%
unnest(cols = reporting_org.narrative,
keep_empty = TRUE) %>%
select(iati_identifier, reporting_org_ref = reporting_org.ref,
reporting_org_type = reporting_org.type.name,
reporting_org = text) %>%
# Account for IDRC having names in 3 languages
filter(reporting_org_ref != "XM-DAC-301-2" | reporting_org == "International Development Research Centre") %>%
unique()
# Lookup country
activity_list_unnest_5 <- activity_list_unnest_5 %>%
mutate(
org_country_iati = case_when(
str_detect(reporting_org_ref, "GB") ~ "United Kingdom",
str_detect(reporting_org_ref, "US") ~ "United States",
str_detect(reporting_org_ref, "NL") ~ "Netherlands",
str_detect(reporting_org_ref, "CA-") ~ "Canada",
str_detect(reporting_org_ref, "IN-") ~ "India",
str_detect(reporting_org_ref, "KE-") ~ "Kenya",
str_detect(reporting_org_ref, "ZA-") ~ "South Africa"),
org_country_other = map(reporting_org, org_country_lookup)) %>%
mutate(org_country_other = unlist(org_country_other)) %>%
mutate(reporting_org_country = coalesce(org_country_iati, org_country_other)) %>%
select(-org_country_iati, -org_country_other)
org_names_and_locations <- activity_list_unnest_5 %>%
select(project_id = iati_identifier,
organisation_name = reporting_org,
organisation_country = reporting_org_country) %>%
mutate(organisation_role = 1)
View(org_names_and_locations)
View(org_names_and_locations)
# Save implementing orgs with country to file
org_names_and_locations <- activity_list_unnest_4 %>%
select(project_id = iati_identifier,
organisation_name = text,
organisation_country = org_country) %>%
mutate(organisation_role = 2)
# Add on to org file to save
org_names_and_locations <- activity_list_unnest_5 %>%
select(project_id = iati_identifier,
organisation_name = reporting_org,
organisation_country = reporting_org_country) %>%
mutate(organisation_role = 1) %>% # leading
org_names_and_locations %>%
unique()
# Save implementing orgs with country to file
org_names_and_locations <- activity_list_unnest_4 %>%
select(project_id = iati_identifier,
organisation_name = text,
organisation_country = org_country) %>%
mutate(organisation_role = 2)
# Add on to org file to save
org_names_and_locations <- activity_list_unnest_5 %>%
select(project_id = iati_identifier,
organisation_name = reporting_org,
organisation_country = reporting_org_country) %>%
mutate(organisation_role = 1) %>% # leading
org_names_and_locations %>%
unique()
# Add on to org file to save
org_names_and_locations <- activity_list_unnest_5 %>%
select(project_id = iati_identifier,
organisation_name = reporting_org,
organisation_country = reporting_org_country) %>%
mutate(organisation_role = 1) %>% # leading
rbind(org_names_and_locations) %>%
unique()
# Save to file
saveRDS(org_names_and_locations, file = "Outputs/org_names_and_locations.rds")
# Read in org names and countries dataset
org_names_and_locations <- readRDS(file = "Outputs/org_names_and_locations.rds")
